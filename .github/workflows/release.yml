name: Build and Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    outputs:
      version: ${{ steps.version.outputs.timestamp }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Generate timestamp version
        id: version
        run: |
          echo "timestamp=$(date -u +'%Y.%m.%d.%H%M')" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        shell: bash

      - name: Update package.json version
        run: |
          npm version ${{ steps.version.outputs.timestamp }} --no-git-tag-version --allow-same-version
        shell: bash

      - name: Install dependencies
        run: npm ci

      - name: Build for Windows
        run: npx electron-builder --win dir
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Create 7z archive
        run: |
          7z a -t7z -mx=9 -mmt=on "dist/WlfRyt-YouTube-Studio-${{ steps.version.outputs.timestamp }}-win-x64.7z" "./dist/win-unpacked/*"
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-win
          path: |
            dist/*.7z
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate timestamp version
        id: version
        run: |
          echo "timestamp=$(date -u +'%Y.%m.%d.%H%M')" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "Artifacts to release:"
          find artifacts -type f -name "*"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.timestamp }}
          name: WlfRyt YouTube Studio - ${{ steps.version.outputs.date }}
          body: |
            ## WlfRyt YouTube Studio v${{ steps.version.outputs.timestamp }}
            
            **Build Date:** ${{ steps.version.outputs.date }}
            
            A standalone desktop application for YouTube Studio with persistent login and hardened security.
            
            ### Downloads
            
            | Platform | File |
            |----------|------|
            | Windows | `WlfRyt-YouTube-Studio-${{ steps.version.outputs.timestamp }}-win-x64.7z` |
            
            ### Features
            - üîê Persistent login with encrypted session storage
            - üõ°Ô∏è Hardened security (sandbox, context isolation)
            - üíª Native desktop experience with system tray
            - üöÄ Auto-start with Windows option
            - üì• Minimize to tray, start minimized
            - üîí Machine-specific encryption keys
            
            ### Installation
            
            **Windows:** Extract the `.7z` archive and run `WlfRyt YouTube Studio.exe`
            
            ---
            
            > ‚ö†Ô∏è This is an unofficial application. YouTube and YouTube Studio are trademarks of Google LLC.
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.7z
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
